<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI旅行规划师</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 科大讯飞语音识别SDK -->
    <script src="https://cdn.jsdelivr.net/npm/iflytek-web-voice@1.0.0/dist/iflytek-web-voice.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <button id="homeBtn" class="text-xl font-bold text-gray-900 hover:text-blue-600 transition-colors">🗺️ AI旅行规划师</button>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="loginBtn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                        登录
                    </button>
                    <button id="registerBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        注册
                    </button>
                    <button id="settingsBtn" class="hidden text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                        设置
                    </button>
                    <button id="logoutBtn" class="hidden text-gray-700 hover:text-red-600 px-3 py-2 rounded-md text-sm font-medium">
                        退出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div id="mainContent">
        <!-- 首页 -->
        <div id="homePage" class="min-h-screen">
            <!-- Hero Section -->
            <section class="gradient-bg text-white py-20">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6">AI旅行规划师</h1>
                    <p class="text-xl md:text-2xl mb-8 text-blue-100">智能语音规划，让旅行更简单</p>
                    <button id="startPlanningBtn" class="bg-white text-blue-600 px-8 py-4 rounded-lg text-lg font-semibold hover:bg-gray-100 transition-colors">
                        开始规划
                    </button>
                </div>
            </section>

            <!-- 我的旅行规划 -->
            <section id="myTripsSection" class="py-20 bg-gray-50 hidden">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">我的旅行规划</h2>
                        <p class="text-xl text-gray-600">管理您的所有旅行计划</p>
                    </div>
                    <div id="tripsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 旅行规划卡片将在这里动态生成 -->
                    </div>
                    <div id="noTripsMessage" class="text-center py-12 hidden">
                        <div class="text-gray-400 text-6xl mb-4">✈️</div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">还没有旅行规划</h3>
                        <p class="text-gray-500 mb-6">开始创建您的第一个AI旅行规划吧！</p>
                        <button id="createFirstTripBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            创建旅行规划
                        </button>
                    </div>
                </div>
            </section>

            <!-- 功能特性 -->
            <section class="py-20 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center mb-16">
                        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">核心功能</h2>
                        <p class="text-xl text-gray-600">让AI成为您的专属旅行顾问</p>
                    </div>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="text-center">
                            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">🎤</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">语音输入</h3>
                            <p class="text-gray-600">支持语音输入旅行需求，AI智能理解并生成个性化行程</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">🧠</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">智能规划</h3>
                            <p class="text-gray-600">AI分析您的偏好，自动生成详细的旅行路线和建议</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">💰</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">费用管理</h3>
                            <p class="text-gray-600">智能预算分析，实时记录旅行开销，让您轻松掌控预算</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">☁️</span>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">云端同步</h3>
                            <p class="text-gray-600">多设备同步，随时随地查看和修改您的旅行计划</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- 登录页面 -->
        <div id="loginPage" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div class="text-center">
                    <button id="backToHomeFromLogin" class="text-blue-600 hover:text-blue-700 mb-4 flex items-center space-x-2">
                        <span>←</span>
                        <span>返回主页</span>
                    </button>
                    <h2 class="text-3xl font-extrabold text-gray-900">登录您的账户</h2>
                </div>
                <form id="loginForm" class="mt-8 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">邮箱地址</label>
                        <input id="loginEmail" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入邮箱地址">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">密码</label>
                        <input id="loginPassword" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入密码">
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            登录
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 注册页面 -->
        <div id="registerPage" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div class="text-center">
                    <button id="backToHomeFromRegister" class="text-blue-600 hover:text-blue-700 mb-4 flex items-center space-x-2">
                        <span>←</span>
                        <span>返回主页</span>
                    </button>
                    <h2 class="text-3xl font-extrabold text-gray-900">创建新账户</h2>
                </div>
                <form id="registerForm" class="mt-8 space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">用户名</label>
                        <input id="registerUsername" type="text" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入用户名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">邮箱地址</label>
                        <input id="registerEmail" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入邮箱地址">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">密码</label>
                        <input id="registerPassword" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入密码（至少6位）">
                    </div>
                    <div>
                        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            注册
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 行程规划页面 -->
        <div id="plannerPage" class="hidden min-h-screen bg-gray-50 py-8">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-8">
                    <button id="backToHomeFromPlanner" class="text-blue-600 hover:text-blue-700 mb-4 flex items-center space-x-2 mx-auto">
                        <span>←</span>
                        <span>返回主页</span>
                    </button>
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">AI智能旅行规划</h1>
                    <p class="text-lg text-gray-600">告诉AI您的旅行需求，让AI为您规划完美的旅行</p>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-8">
                    <form id="tripForm" class="space-y-6">
                        <!-- 语音输入区域 -->
                        <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center">
                            <div class="flex items-center justify-center mb-4">
                                <span class="text-2xl mr-2">🎤</span>
                                <h3 class="text-lg font-semibold text-gray-900">智能语音输入</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">说出您的旅行需求，AI会自动填写表单</p>
                            
                            <!-- 语音示例 -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
                                <h4 class="text-sm font-semibold text-gray-800 mb-2">💡 语音示例：</h4>
                                <div class="text-xs text-gray-600 space-y-1">
                                    <p>• "我想去日本，5天，预算1万元，喜欢美食和动漫，带孩子"</p>
                                    <p>• "计划去韩国旅行，3天时间，预算5000元，2个人，喜欢购物"</p>
                                    <p>• "到泰国玩7天，预算8000元，4个人，喜欢自然风景"</p>
                                </div>
                            </div>
                            
                            <button type="button" id="voiceBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 mx-auto">
                                <span>🎤</span>
                                <span>开始语音输入</span>
                            </button>
                            
                            <!-- 语音状态指示器 -->
                            <div id="voiceStatus" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                    <span class="text-sm text-blue-600">正在识别语音...</span>
                                </div>
                            </div>
                            
                            <div id="voiceResult" class="mt-4 p-4 bg-blue-50 rounded-lg hidden">
                                <p class="text-sm text-blue-800">
                                    <strong>语音识别结果：</strong> <span id="voiceText"></span>
                                </p>
                            </div>
                            
                            <div class="mt-3 flex justify-between items-center">
                                <div class="text-xs text-gray-500">
                                    <p>💡 使用科大讯飞语音识别，支持中文语音输入，请清晰地说出您的需求</p>
                                </div>
                                <button type="button" onclick="clearForm()" class="text-xs text-gray-500 hover:text-gray-700 underline">
                                    🗑️ 清空表单
                                </button>
                            </div>
                        </div>

                        <!-- 基本信息表单 -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">🗺️ 目的地 *</label>
                                <input type="text" id="destination" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入目的地，如：日本东京">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">👥 同行人数</label>
                                <input type="number" id="travelers" value="1" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">📅 出发日期 *</label>
                                <input type="date" id="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">📅 返回日期 *</label>
                                <input type="date" id="endDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">💰 预算 (元) *</label>
                                <input type="number" id="budget" min="0" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入预算金额">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">旅行偏好</label>
                            <textarea id="preferences" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请描述您的旅行偏好，如：喜欢美食、文化景点、购物等"></textarea>
                        </div>

                        <div class="flex justify-center">
                            <button type="submit" id="generateBtn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <span>🧠</span>
                                <span>生成AI旅行计划</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 设置页面 -->
        <div id="settingsPage" class="hidden min-h-screen bg-gray-50 py-8">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-8">
                    <button id="backToHomeFromSettings" class="text-blue-600 hover:text-blue-700 mb-4 flex items-center space-x-2 mx-auto">
                        <span>←</span>
                        <span>返回主页</span>
                    </button>
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">设置</h1>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-8">
                    <form id="settingsForm" class="space-y-8">
                        <!-- API Key 设置 -->
                        <div class="border-b border-gray-200 pb-8">
                            <div class="flex items-center mb-4">
                                <span class="text-2xl mr-3">🔑</span>
                                <h2 class="text-xl font-semibold text-gray-900">API 配置</h2>
                            </div>
                            <p class="text-gray-600 mb-4">
                                配置您的阿里云百炼 API Key 以使用 AI 功能。您可以在{' '}
                                <a href="https://bailian.console.aliyun.com/" target="_blank" class="text-blue-600 hover:text-blue-700 underline">
                                    阿里云百炼控制台
                                </a>{' '}
                                获取 API Key。
                            </p>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">阿里云百炼 API Key</label>
                                <div class="relative">
                                    <input type="password" id="openaiApiKey" class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="请输入您的阿里云百炼 API Key">
                                    <button type="button" id="toggleApiKey" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                                        <span id="toggleApiKeyIcon">👁️</span>
                                    </button>
                                </div>
                                <p class="text-sm text-gray-500 mt-1">
                                    您的阿里云百炼 API Key 将安全存储在您的账户中，仅用于 AI 功能。
                                </p>
                            </div>
                        </div>

                        <!-- 语言设置 -->
                        <div class="border-b border-gray-200 pb-8">
                            <div class="flex items-center mb-4">
                                <span class="text-2xl mr-3">🌐</span>
                                <h2 class="text-xl font-semibold text-gray-900">语言设置</h2>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">界面语言</label>
                                <select id="language" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="zh-CN">简体中文</option>
                                    <option value="en-US">English</option>
                                    <option value="ja-JP">日本語</option>
                                    <option value="ko-KR">한국어</option>
                                </select>
                            </div>
                        </div>

                        <!-- 货币设置 -->
                        <div class="border-b border-gray-200 pb-8">
                            <div class="flex items-center mb-4">
                                <span class="text-2xl mr-3">💰</span>
                                <h2 class="text-xl font-semibold text-gray-900">货币设置</h2>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">默认货币</label>
                                <select id="currency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="CNY">人民币 (¥)</option>
                                    <option value="USD">美元 ($)</option>
                                    <option value="EUR">欧元 (€)</option>
                                    <option value="JPY">日元 (¥)</option>
                                    <option value="KRW">韩元 (₩)</option>
                                </select>
                            </div>
                        </div>

                        <!-- 保存按钮 -->
                        <div class="flex justify-end">
                            <button type="submit" id="saveSettingsBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center space-x-2">
                                <span>💾</span>
                                <span>保存设置</span>
                            </button>
                        </div>
                    </form>

                    <!-- 使用说明 -->
                    <div class="mt-12 bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-900 mb-3">使用说明</h3>
                        <div class="text-blue-800 space-y-2">
                            <p>• 配置阿里云百炼 API Key 后，您可以使用 AI 智能规划功能</p>
                            <p>• 支持语音输入旅行需求，AI 会自动生成个性化行程</p>
                            <p>• 所有数据都会安全存储在云端，支持多设备同步</p>
                            <p>• 您可以随时修改这些设置，更改会立即生效</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 结果页面 -->
        <div id="resultPage" class="hidden min-h-screen bg-gray-50 py-8">
            <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-6">
                    <button id="backToHomeFromResult" class="text-blue-600 hover:text-blue-700 mb-4 flex items-center space-x-2 mx-auto">
                        <span>←</span>
                        <span>返回主页</span>
                    </button>
                    <button id="createNewTrip" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center space-x-2 mx-auto">
                        <span>➕</span>
                        <span>创建新行程</span>
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h1 class="text-3xl font-bold text-gray-900 mb-4">您的AI旅行计划</h1>
                    <div id="tripResult" class="space-y-4">
                        <!-- 结果将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知区域 -->
    <div id="notification" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden">
        <span id="notificationText"></span>
    </div>

    <script>
        // 全局变量
        let currentUser = null;
        let isRecording = false;

        // 页面切换函数
        function showPage(pageId) {
            document.querySelectorAll('[id$="Page"]').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            
            // 如果显示设置页面，加载用户设置
            if (pageId === 'settingsPage') {
                loadUserSettings();
            }
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = message;
            
            let bgColor = 'bg-green-500';
            if (type === 'error') {
                bgColor = 'bg-red-500';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
            }
            
            notification.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg ${bgColor}`;
            notification.classList.remove('hidden');
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // 事件监听器
        document.getElementById('homeBtn').addEventListener('click', () => {
            showPage('homePage');
            // 如果用户已登录，刷新旅行规划列表
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        document.getElementById('loginBtn').addEventListener('click', () => showPage('loginPage'));
        document.getElementById('registerBtn').addEventListener('click', () => showPage('registerPage'));
        document.getElementById('settingsBtn').addEventListener('click', () => showPage('settingsPage'));
        document.getElementById('startPlanningBtn').addEventListener('click', () => showPage('plannerPage'));
        document.getElementById('createFirstTripBtn').addEventListener('click', () => showPage('plannerPage'));
        
        // 返回主页按钮
        document.getElementById('backToHomeFromLogin').addEventListener('click', () => {
            showPage('homePage');
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        document.getElementById('backToHomeFromRegister').addEventListener('click', () => {
            showPage('homePage');
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        document.getElementById('backToHomeFromPlanner').addEventListener('click', () => {
            showPage('homePage');
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        document.getElementById('backToHomeFromResult').addEventListener('click', () => {
            showPage('homePage');
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        document.getElementById('backToHomeFromSettings').addEventListener('click', () => {
            showPage('homePage');
            if (localStorage.getItem('token') && typeof loadUserTrips === 'function') {
                loadUserTrips();
            }
        });
        
        // 创建新行程按钮
        document.getElementById('createNewTrip').addEventListener('click', () => showPage('plannerPage'));
        
        // 退出登录
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            currentUser = null;
            updateNavbarForGuest();
            showPage('homePage');
            showNotification('已退出登录');
        });

        // 登录表单
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                
                if (data.token) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    showNotification('登录成功！');
                    updateNavbarForLoggedInUser();
                    showPage('plannerPage');
                } else {
                    showNotification(data.message || '登录失败', 'error');
                }
            } catch (error) {
                showNotification('登录失败，请重试', 'error');
            }
        });

        // 注册表单
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                const data = await response.json();
                
                if (data.token) {
                    currentUser = data.user;
                    localStorage.setItem('token', data.token);
                    showNotification('注册成功！');
                    updateNavbarForLoggedInUser();
                    showPage('plannerPage');
                } else {
                    showNotification(data.message || '注册失败', 'error');
                }
            } catch (error) {
                showNotification('注册失败，请重试', 'error');
            }
        });

        // 清空表单函数
        function clearForm() {
            document.getElementById('destination').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('budget').value = '';
            document.getElementById('travelers').value = '';
            document.getElementById('preferences').value = '';
            document.getElementById('voiceText').textContent = '';
            document.getElementById('voiceResult').classList.add('hidden');
            showNotification('表单已清空', 'success');
        }

        // AI语音解析函数
        async function parseVoiceWithAI(transcript) {
            try {
                console.log('🤖 开始AI语音解析...');
                showNotification('AI正在解析语音内容...', 'info');
                
                const response = await fetch('/api/ai/parse-voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        voiceText: transcript
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    console.log('✅ AI解析成功:', result.data);
                    
                    // 自动填充表单
                    fillFormWithData(result.data);
                    
                    showNotification(`AI解析完成！已自动填写：${Object.keys(result.data).join('、')}`, 'success');
                } else {
                    console.error('❌ AI解析失败:', result.error);
                    showNotification('AI解析失败，请重试', 'error');
                }
            } catch (error) {
                console.error('❌ AI解析请求失败:', error);
                showNotification('解析服务暂时不可用，请手动填写', 'error');
            }
        }

        // 使用解析数据填充表单
        function fillFormWithData(data) {
            console.log('📝 开始填充表单:', data);
            
            let filledFields = [];
            
            // 填充目的地
            if (data.destination) {
                document.getElementById('destination').value = data.destination;
                filledFields.push('目的地');
                console.log('✅ 填充目的地:', data.destination);
            }
            
            // 填充出发日期
            if (data.startDate) {
                document.getElementById('startDate').value = data.startDate;
                filledFields.push('出发日期');
                console.log('✅ 填充出发日期:', data.startDate);
            }
            
            // 填充返回日期
            if (data.endDate) {
                document.getElementById('endDate').value = data.endDate;
                filledFields.push('返回日期');
                console.log('✅ 填充返回日期:', data.endDate);
            }
            
            // 填充预算
            if (data.budget) {
                document.getElementById('budget').value = data.budget;
                filledFields.push('预算');
                console.log('✅ 填充预算:', data.budget);
            }
            
            // 填充人数
            if (data.travelers) {
                document.getElementById('travelers').value = data.travelers;
                filledFields.push('人数');
                console.log('✅ 填充人数:', data.travelers);
            }
            
            // 填充偏好
            if (data.preferences && Array.isArray(data.preferences)) {
                document.getElementById('preferences').value = data.preferences.join(', ');
                filledFields.push('偏好');
                console.log('✅ 填充偏好:', data.preferences);
            }
            
            console.log('📊 填充完成，已填写字段:', filledFields);
        }

        // 智能语音解析函数
        function parseVoiceInput(transcript) {
            console.log('🧠 开始解析语音输入:', transcript);
            
            // 目的地解析 - 支持多种表达方式，优化匹配精度
            const destinationPatterns = [
                /去([^，\d]+?)(?:，|$|旅行|旅游|玩)/,
                /到([^，\d]+?)(?:，|$|旅行|旅游|玩)/,
                /([^，\d]+?)(?:旅行|旅游)(?:，|$)/,
                /我想去([^，\d]+?)(?:，|$)/,
                /计划去([^，\d]+?)(?:，|$)/
            ];
            
            let destination = null;
            for (const pattern of destinationPatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    destination = match[1].trim();
                    // 清理目的地名称，移除数字和多余词汇
                    destination = destination.replace(/\d+天|\d+日|\d+元|\d+万|\d+千|\d+人|\d+个/, '').trim();
                    if (destination.length > 0 && destination.length < 10) { // 限制长度
                        break;
                    }
                }
            }
            
            // 天数解析 - 支持多种表达方式
            const daysPatterns = [
                /(\d+)(?:天|日)/,
                /(\d+)(?:天|日)的旅行/,
                /玩(\d+)(?:天|日)/,
                /(\d+)(?:天|日)时间/,
                /(\d+)(?:天|日)行程/,
                /(\d+)(?:天|日)计划/,
                /(\d+)(?:天|日)安排/,
                /(\d+)(?:天|日)假期/
            ];
            
            let days = null;
            for (const pattern of daysPatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    days = parseInt(match[1]);
                    break;
                }
            }
            
            // 预算解析 - 支持多种表达方式
            const budgetPatterns = [
                /预算(\d+)(?:元|万|千)/,
                /(\d+)(?:元|万|千)预算/,
                /(\d+)(?:元|万|千)左右/,
                /(\d+)(?:元|万|千)以内/,
                /花费(\d+)(?:元|万|千)/,
                /(\d+)(?:元|万|千)的花费/,
                /(\d+)(?:元|万|千)钱/,
                /(\d+)(?:元|万|千)块/,
                /(\d+)(?:元|万|千)费用/,
                /(\d+)(?:元|万|千)开销/
            ];
            
            let budget = null;
            for (const pattern of budgetPatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    let amount = parseInt(match[1]);
                    if (transcript.includes('万')) {
                        amount = amount * 10000;
                    } else if (transcript.includes('千')) {
                        amount = amount * 1000;
                    }
                    budget = amount;
                    break;
                }
            }
            
            // 人数解析 - 增强识别能力
            const peoplePatterns = [
                /(\d+)(?:人|个)/,
                /(\d+)(?:人|个)一起/,
                /(\d+)(?:人|个)同行/,
                /带(\d+)(?:人|个)/,
                /(\d+)(?:人|个)去/,
                /(\d+)(?:人|个)旅行/,
                /(\d+)(?:人|个)旅游/,
                /(\d+)(?:人|个)玩/,
                /(\d+)(?:人|个)出行/,
                /(\d+)(?:人|个)出发/
            ];
            
            let people = null;
            for (const pattern of peoplePatterns) {
                const match = transcript.match(pattern);
                if (match) {
                    people = parseInt(match[1]);
                    break;
                }
            }
            
            // 特殊表达处理：带孩子、带娃等
            if (!people) {
                if (transcript.includes('带孩子') || transcript.includes('带娃') || transcript.includes('亲子')) {
                    people = 2; // 默认1个大人+1个孩子
                }
            }
            
            // 偏好解析 - 提取关键词
            const preferenceKeywords = {
                '美食': ['美食', '吃', '餐厅', '小吃', '料理', '美食'],
                '购物': ['购物', '买', '商店', '商场', '购物'],
                '文化': ['文化', '历史', '博物馆', '古迹', '传统'],
                '自然': ['自然', '风景', '山水', '公园', '海滩'],
                '动漫': ['动漫', '动画', '二次元', '手办', '漫画'],
                '娱乐': ['娱乐', '游乐', '游戏', 'KTV', '酒吧'],
                '亲子': ['亲子', '孩子', '儿童', '家庭', '带娃']
            };
            
            let preferences = [];
            for (const [category, keywords] of Object.entries(preferenceKeywords)) {
                for (const keyword of keywords) {
                    if (transcript.includes(keyword)) {
                        preferences.push(category);
                        break;
                    }
                }
            }
            
            // 应用解析结果
            let filledFields = [];
            
            if (destination) {
                const destinationField = document.getElementById('destination');
                if (destinationField) {
                    destinationField.value = destination;
                    filledFields.push('目的地');
                    console.log('✅ 解析到目的地:', destination);
                } else {
                    console.error('❌ 找不到目的地输入框');
                }
            }
            
            if (days) {
                const startDateField = document.getElementById('startDate');
                const endDateField = document.getElementById('endDate');
                if (startDateField && endDateField) {
                    const startDate = new Date();
                    const endDate = new Date();
                    endDate.setDate(startDate.getDate() + days);
                    startDateField.value = startDate.toISOString().split('T')[0];
                    endDateField.value = endDate.toISOString().split('T')[0];
                    filledFields.push('日期');
                    console.log('✅ 解析到天数:', days, '开始日期:', startDateField.value, '结束日期:', endDateField.value);
                } else {
                    console.error('❌ 找不到日期输入框');
                }
            }
            
            if (budget) {
                const budgetField = document.getElementById('budget');
                if (budgetField) {
                    budgetField.value = budget;
                    filledFields.push('预算');
                    console.log('✅ 解析到预算:', budget);
                } else {
                    console.error('❌ 找不到预算输入框');
                }
            }
            
            if (people) {
                const travelersField = document.getElementById('travelers');
                if (travelersField) {
                    travelersField.value = people;
                    filledFields.push('人数');
                    console.log('✅ 解析到人数:', people);
                } else {
                    console.error('❌ 找不到人数输入框');
                }
            }
            
            if (preferences.length > 0) {
                const preferencesField = document.getElementById('preferences');
                if (preferencesField) {
                    preferencesField.value = preferences.join(', ');
                    filledFields.push('偏好');
                    console.log('✅ 解析到偏好:', preferences);
                } else {
                    console.error('❌ 找不到偏好输入框');
                }
            }
            
            // 显示解析结果
            if (filledFields.length > 0) {
                showNotification(`语音解析完成！已自动填写：${filledFields.join('、')}`, 'success');
            } else {
                showNotification('语音解析完成，但未识别到可填充的信息', 'info');
            }
        }

        // 语音输入
        document.getElementById('voiceBtn').addEventListener('click', () => {
            if (!isRecording) {
                startVoiceRecording();
            } else {
                stopVoiceRecording();
            }
        });

        // 科大讯飞语音识别配置
        const xunfeiConfig = {
            appId: '3f1adedc',
            // 注意：实际使用时需要配置正确的API Key和Secret
            // 这里使用演示配置
            apiKey: 'demo_key',
            apiSecret: 'demo_secret'
        };

        function startVoiceRecording() {
            try {
                console.log('🎤 开始科大讯飞语音识别...');
                
                // 检查科大讯飞SDK是否加载
                if (typeof window.IFlytekWebVoice === 'undefined') {
                    showNotification('科大讯飞语音识别SDK未加载，请刷新页面重试', 'error');
                    return;
                }
                
                // 更新UI状态
                isRecording = true;
                document.getElementById('voiceBtn').innerHTML = '<span>⏹️</span><span>停止录音</span>';
                document.getElementById('voiceBtn').className = 'bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center space-x-2 mx-auto';
                document.getElementById('voiceStatus').classList.remove('hidden');
                document.getElementById('voiceResult').classList.add('hidden');
                
                // 初始化科大讯飞语音识别
                const voiceRecognition = new window.IFlytekWebVoice({
                    appId: xunfeiConfig.appId,
                    // 实际使用时需要正确的认证信息
                    // apiKey: xunfeiConfig.apiKey,
                    // apiSecret: xunfeiConfig.apiSecret,
                    language: 'zh_cn',
                    accent: 'mandarin'
                });
                
                // 保存实例引用
                window.currentVoiceRecognition = voiceRecognition;
                
                // 开始识别
                voiceRecognition.start({
                    onResult: async (result) => {
                        console.log('🎤 科大讯飞识别结果:', result);
                        
                        if (result && result.text) {
                            const transcript = result.text;
                            document.getElementById('voiceText').textContent = transcript;
                            document.getElementById('voiceResult').classList.remove('hidden');
                            
                            console.log('🎤 语音识别结果:', transcript);
                            
                            // 调用AI解析语音输入
                            await parseVoiceWithAI(transcript);
                        }
                    },
                    onError: (error) => {
                        console.error('❌ 科大讯飞识别错误:', error);
                        showNotification('语音识别失败，请重试', 'error');
                        stopVoiceRecording();
                    },
                    onComplete: () => {
                        console.log('✅ 科大讯飞识别完成');
                        stopVoiceRecording();
                    }
                });
                
            } catch (error) {
                console.error('❌ 科大讯飞语音识别初始化失败:', error);
                showNotification('语音识别服务初始化失败，请重试', 'error');
                stopVoiceRecording();
            }
        }

        function stopVoiceRecording() {
            isRecording = false;
            document.getElementById('voiceBtn').innerHTML = '<span>🎤</span><span>开始语音输入</span>';
            document.getElementById('voiceBtn').className = 'bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 mx-auto';
            document.getElementById('voiceStatus').classList.add('hidden');
            
            // 如果有科大讯飞实例，停止识别
            if (window.currentVoiceRecognition) {
                try {
                    window.currentVoiceRecognition.stop();
                } catch (error) {
                    console.log('停止语音识别:', error);
                }
            }
        }

        // 行程规划表单
        document.getElementById('tripForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                destination: document.getElementById('destination').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                budget: document.getElementById('budget').value,
                travelers: document.getElementById('travelers').value,
                preferences: document.getElementById('preferences').value
            };
            
            if (!formData.destination || !formData.startDate || !formData.endDate || !formData.budget) {
                showNotification('请填写所有必填字段', 'error');
                return;
            }
            
            document.getElementById('generateBtn').innerHTML = '<span>⏳</span><span>AI正在规划中...</span>';
            document.getElementById('generateBtn').disabled = true;
            
            try {
                // 获取用户配置的API Key
                const userApiKey = currentUser?.preferences?.openaiApiKey || '';
                
                // 在演示模式下，如果没有配置API Key，使用演示模式
                if (!userApiKey) {
                    showNotification('使用演示模式生成旅行规划（配置API Key后可获得更智能的AI规划）', 'info');
                }
                
                // 优先使用RAG和工具流接口
                const response = await fetch('/api/ai/generate-trip-rag', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'X-API-Key': userApiKey
                    },
                    body: JSON.stringify({
                        ...formData,
                        apiKey: userApiKey
                    })
                });
                const data = await response.json();
                
                if (data.data) {
                    // 显示API调用状态
                    if (data.apiStatus && data.apiMessage) {
                        showNotification(data.apiMessage, data.apiStatus === 'success' ? 'success' : 'info');
                    }
                    
                    // 创建旅行计划
                    const tripResponse = await fetch('/api/trips', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            title: `${formData.destination} ${formData.startDate} 旅行`,
                            destination: formData.destination,
                            startDate: formData.startDate,
                            endDate: formData.endDate,
                            budget: parseInt(formData.budget),
                            travelers: parseInt(formData.travelers),
                            preferences: {
                                interests: formData.preferences.split(',').map(s => s.trim()),
                                specialRequirements: document.getElementById('voiceText').textContent || ''
                            },
                            aiGenerated: true,
                            aiData: data.data // 传递AI生成的数据
                        })
                    });
                    
                    const tripData = await tripResponse.json();
                    displayTripResult(tripData.trip, data.data);
                    showNotification('AI旅行计划生成成功！');
                    
                    // 刷新主页的旅行规划列表
                    if (typeof loadUserTrips === 'function') {
                        loadUserTrips();
                    }
                } else {
                    showNotification('生成旅行计划失败，请重试', 'error');
                }
            } catch (error) {
                showNotification('生成旅行计划失败，请重试', 'error');
            } finally {
                document.getElementById('generateBtn').innerHTML = '<span>🧠</span><span>生成AI旅行计划</span>';
                document.getElementById('generateBtn').disabled = false;
            }
        });

        function displayTripResult(trip, aiData) {
            const resultDiv = document.getElementById('tripResult');
            
            // 安全地处理可能为null或undefined的数据
            const safeAiData = aiData || {};
            const itinerary = safeAiData.itinerary || [];
            const recommendations = safeAiData.recommendations || {};
            
            // 生成分页导航
            const totalDays = itinerary.length;
            let currentDay = 0;
            
            function generateDayContent(dayIndex) {
                if (dayIndex >= itinerary.length) return '';
                const day = itinerary[dayIndex];
                return `
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h4 class="font-semibold text-gray-900">${new Date(day.date).toLocaleDateString('zh-CN')}</h4>
                        <div class="mt-2 space-y-2">
                            ${day.activities ? day.activities.map(activity => `
                                <div class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg">
                                    <span class="text-gray-400">🕐</span>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-900">${activity.title}</p>
                                                <p class="text-sm text-gray-600">${activity.description}</p>
                                                ${activity.location ? `<p class="text-xs text-blue-600">📍 ${activity.location}</p>` : ''}
                                            </div>
                                            <div class="text-right">
                                                ${activity.cost ? `<p class="text-sm font-bold text-green-600">¥${activity.cost}</p>` : ''}
                                                ${activity.category ? `<p class="text-xs text-gray-500">${activity.category}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = `
                <div class="bg-blue-50 p-6 rounded-lg mb-6">
                    <h2 class="text-2xl font-bold text-blue-900 mb-4">${trip.title}</h2>
                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg">
                            <div class="text-sm font-medium text-blue-800">总预算</div>
                            <div class="text-2xl font-bold text-blue-900">¥${trip.budget.toLocaleString()}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg">
                            <div class="text-sm font-medium text-green-800">目的地</div>
                            <div class="text-2xl font-bold text-green-900">${trip.destination}</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg">
                            <div class="text-sm font-medium text-purple-800">同行人数</div>
                            <div class="text-2xl font-bold text-purple-900">${trip.travelers}人</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">AI生成的行程安排</h3>
                        ${totalDays > 1 ? `
                            <div class="flex items-center space-x-2">
                                <button id="prevDayBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50" disabled>
                                    ← 前一天
                                </button>
                                <span id="dayInfo" class="text-sm text-gray-600">第 1 天 / 共 ${totalDays} 天</span>
                                <button id="nextDayBtn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 disabled:opacity-50" ${totalDays <= 1 ? 'disabled' : ''}>
                                    后一天 →
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    <div id="dayContent" class="space-y-4">
                        ${itinerary.length > 0 ? `
                            <div class="border-l-4 border-blue-500 pl-4">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-semibold text-gray-900">${itinerary[0].dayTitle || new Date(itinerary[0].date).toLocaleDateString('zh-CN')}</h4>
                                    ${itinerary[0].dailyBudget ? `<span class="text-sm font-bold text-green-600">每日预算: ¥${itinerary[0].dailyBudget}</span>` : ''}
                                </div>
                                <div class="mt-2 space-y-2">
                                    ${itinerary[0].activities ? itinerary[0].activities.map(activity => `
                                        <div class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg hover:bg-gray-100 transition-colors">
                                            <span class="text-gray-400">🕐</span>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-medium text-gray-900">${activity.title}</p>
                                                        <p class="text-sm text-gray-600">${activity.description}</p>
                                                        ${activity.location ? `<p class="text-xs text-blue-600">📍 ${activity.location}</p>` : ''}
                                                    </div>
                                                    <div class="text-right">
                                                        ${activity.cost ? `<p class="text-sm font-bold text-green-600">¥${activity.cost}</p>` : ''}
                                                        ${activity.category ? `<p class="text-xs text-gray-500">${activity.category}</p>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('') : ''}
                                </div>
                            </div>
                        ` : '<p class="text-gray-500">暂无行程安排</p>'}
                    </div>
                </div>
                
                ${safeAiData.budgetSummary ? `
                    <div class="bg-white p-6 rounded-lg mt-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">💰 预算分配</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-blue-800">交通费用</div>
                                <div class="text-2xl font-bold text-blue-900">¥${safeAiData.budgetSummary.transportation?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-green-800">住宿费用</div>
                                <div class="text-2xl font-bold text-green-900">¥${safeAiData.budgetSummary.accommodation?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-yellow-800">餐饮费用</div>
                                <div class="text-2xl font-bold text-yellow-900">¥${safeAiData.budgetSummary.dining?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-purple-800">景点门票</div>
                                <div class="text-2xl font-bold text-purple-900">¥${safeAiData.budgetSummary.attractions?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-pink-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-pink-800">购物预算</div>
                                <div class="text-2xl font-bold text-pink-900">¥${safeAiData.budgetSummary.shopping?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-gray-800">总预算</div>
                                <div class="text-2xl font-bold text-gray-900">¥${safeAiData.budgetSummary.total?.toLocaleString() || '0'}</div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${recommendations && (recommendations.restaurants || recommendations.attractions || recommendations.tips) ? `
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${recommendations.restaurants && recommendations.restaurants.length > 0 ? `
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    <span class="mr-2">🍽️</span>
                                    餐厅推荐
                                </h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    ${recommendations.restaurants.map(restaurant => `<li>• ${restaurant}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${recommendations.attractions && recommendations.attractions.length > 0 ? `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                                    <span class="mr-2">🏛️</span>
                                    景点推荐
                                </h4>
                                <ul class="text-sm text-green-700 space-y-1">
                                    ${recommendations.attractions.map(attraction => `<li>• ${attraction}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${recommendations.tips && recommendations.tips.length > 0 ? `
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-2">💡</span>
                                    实用贴士
                                </h4>
                                <ul class="text-sm text-blue-700 space-y-1">
                                    ${recommendations.tips.map(tip => `<li>• ${tip}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;
            
            // 添加分页导航事件监听器
            if (totalDays > 1) {
                const prevBtn = document.getElementById('prevDayBtn');
                const nextBtn = document.getElementById('nextDayBtn');
                const dayInfo = document.getElementById('dayInfo');
                const dayContent = document.getElementById('dayContent');
                
                function updateDayDisplay() {
                    if (currentDay >= itinerary.length) return;
                    const day = itinerary[currentDay];
                    dayContent.innerHTML = `
                        <div class="border-l-4 border-blue-500 pl-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-gray-900">${day.dayTitle || new Date(day.date).toLocaleDateString('zh-CN')}</h4>
                                ${day.dailyBudget ? `<span class="text-sm font-bold text-green-600">每日预算: ¥${day.dailyBudget}</span>` : ''}
                            </div>
                            <div class="mt-2 space-y-2">
                                ${day.activities ? day.activities.map(activity => `
                                    <div class="flex items-start space-x-3 bg-gray-50 p-3 rounded-lg hover:bg-gray-100 transition-colors">
                                        <span class="text-gray-400">🕐</span>
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start">
                                                <div>
                                                    <p class="font-medium text-gray-900">${activity.title}</p>
                                                    <p class="text-sm text-gray-600">${activity.description}</p>
                                                    ${activity.location ? `<p class="text-xs text-blue-600">📍 ${activity.location}</p>` : ''}
                                                </div>
                                                <div class="text-right">
                                                    ${activity.cost ? `<p class="text-sm font-bold text-green-600">¥${activity.cost}</p>` : ''}
                                                    ${activity.category ? `<p class="text-xs text-gray-500">${activity.category}</p>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                            </div>
                        </div>
                    `;
                    dayInfo.textContent = `第 ${currentDay + 1} 天 / 共 ${totalDays} 天`;
                    prevBtn.disabled = currentDay === 0;
                    nextBtn.disabled = currentDay === totalDays - 1;
                }
                
                prevBtn.addEventListener('click', () => {
                    if (currentDay > 0) {
                        currentDay--;
                        updateDayDisplay();
                    }
                });
                
                nextBtn.addEventListener('click', () => {
                    if (currentDay < totalDays - 1) {
                        currentDay++;
                        updateDayDisplay();
                    }
                });
            }
            
            showPage('resultPage');
        }

        // 更新导航栏状态
        function updateNavbarForLoggedInUser() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('registerBtn').classList.add('hidden');
            document.getElementById('settingsBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            
            // 显示我的旅行规划部分
            document.getElementById('myTripsSection').classList.remove('hidden');
        }

        function updateNavbarForGuest() {
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('registerBtn').classList.remove('hidden');
            document.getElementById('settingsBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        // API Key 显示/隐藏切换
        document.getElementById('toggleApiKey').addEventListener('click', () => {
            const apiKeyInput = document.getElementById('openaiApiKey');
            const toggleIcon = document.getElementById('toggleApiKeyIcon');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.textContent = '🙈';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.textContent = '👁️';
            }
        });

        // 设置表单处理
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const apiKey = document.getElementById('openaiApiKey').value;
            const language = document.getElementById('language').value;
            const currency = document.getElementById('currency').value;
            
            document.getElementById('saveSettingsBtn').innerHTML = '<span>⏳</span><span>保存中...</span>';
            document.getElementById('saveSettingsBtn').disabled = true;
            
            try {
                const response = await fetch('/api/auth/settings', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        preferences: {
                            openaiApiKey: apiKey,
                            language: language,
                            currency: currency
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('设置保存成功！');
                    // 更新当前用户信息
                    if (currentUser) {
                        currentUser.preferences = data.user.preferences;
                    }
                } else {
                    showNotification(data.message || '保存设置失败', 'error');
                }
            } catch (error) {
                showNotification('保存设置失败，请重试', 'error');
            } finally {
                document.getElementById('saveSettingsBtn').innerHTML = '<span>💾</span><span>保存设置</span>';
                document.getElementById('saveSettingsBtn').disabled = false;
            }
        });

        // 加载用户设置
        function loadUserSettings() {
            if (currentUser && currentUser.preferences) {
                document.getElementById('openaiApiKey').value = currentUser.preferences.openaiApiKey || '';
                document.getElementById('language').value = currentUser.preferences.language || 'zh-CN';
                document.getElementById('currency').value = currentUser.preferences.currency || 'CNY';
            }
        }

        // 加载用户的旅行规划
        async function loadUserTrips() {
            try {
                const response = await fetch('/api/trips', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📋 前端接收到的旅行规划数据:', data);
                    displayUserTrips(data || []);
                } else {
                    console.error('加载旅行规划失败');
                    displayUserTrips([]);
                }
            } catch (error) {
                console.error('加载旅行规划失败:', error);
                displayUserTrips([]);
            }
        }

        // 显示用户的旅行规划
        function displayUserTrips(trips) {
            const tripsList = document.getElementById('tripsList');
            const noTripsMessage = document.getElementById('noTripsMessage');
            
            if (trips.length === 0) {
                tripsList.innerHTML = '';
                noTripsMessage.classList.remove('hidden');
                return;
            }
            
            noTripsMessage.classList.add('hidden');
            tripsList.innerHTML = trips.map(trip => `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">${trip.title}</h3>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span class="flex items-center">
                                        <span class="mr-1">📅</span>
                                        ${new Date(trip.createdAt).toLocaleDateString('zh-CN')}
                                    </span>
                                    <span class="flex items-center">
                                        <span class="mr-1">${trip.aiGenerated ? '🤖' : '📝'}</span>
                                        ${trip.aiGenerated ? 'AI生成' : '手动创建'}
                                    </span>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editTrip('${trip._id}')" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                                    ✏️ 编辑
                                </button>
                                <button onclick="deleteTrip('${trip._id}')" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded hover:bg-red-50 transition-colors">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <span class="mr-2">📍</span>
                                    <span class="font-medium">${trip.destination}</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="mr-2">📅</span>
                                    <span>${new Date(trip.startDate).toLocaleDateString('zh-CN')} - ${new Date(trip.endDate).toLocaleDateString('zh-CN')}</span>
                                </div>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center text-gray-600">
                                    <span class="mr-2">💰</span>
                                    <span class="font-bold text-green-600">¥${trip.budget?.toLocaleString() || '0'}</span>
                                </div>
                                <div class="flex items-center text-gray-600">
                                    <span class="mr-2">👥</span>
                                    <span>${trip.travelers}人</span>
                                </div>
                            </div>
                        </div>
                        
                        ${trip.aiData && trip.aiData.summary ? `
                            <div class="bg-gray-50 p-3 rounded-lg mb-4">
                                <p class="text-sm text-gray-700 line-clamp-2">${trip.aiData.summary.substring(0, 100)}${trip.aiData.summary.length > 100 ? '...' : ''}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-500">
                                创建于 ${new Date(trip.createdAt).toLocaleString('zh-CN')}
                            </div>
                            <button onclick="viewTrip('${trip._id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-colors flex items-center">
                                <span class="mr-1">👁️</span>
                                查看详情
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 查看旅行规划详情
        async function viewTrip(tripId) {
            try {
                showNotification('正在加载旅行规划详情...', 'info');
                
                const response = await fetch(`/api/trips/${tripId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const trip = await response.json();
                    displayTripDetail(trip);
                } else {
                    showNotification('获取旅行规划详情失败', 'error');
                }
            } catch (error) {
                console.error('查看旅行规划失败:', error);
                showNotification('查看旅行规划失败，请重试', 'error');
            }
        }
        
        // 显示旅行规划详情
        function displayTripDetail(trip) {
            const resultDiv = document.getElementById('tripResult');
            
            // 构建详情页面HTML
            resultDiv.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <!-- 头部信息 -->
                    <div class="border-b border-gray-200 pb-6 mb-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h2 class="text-3xl font-bold text-gray-900 mb-2">${trip.title}</h2>
                                <div class="flex items-center space-x-6 text-gray-600">
                                    <div class="flex items-center">
                                        <span class="mr-2">📍</span>
                                        <span>${trip.destination}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="mr-2">📅</span>
                                        <span>${trip.startDate} - ${trip.endDate}</span>
                                    </div>
                                    <div class="flex items-center">
                                        <span class="mr-2">👥</span>
                                        <span>${trip.travelers}人</span>
                                    </div>
                                </div>
                            </div>
                            <button onclick="showPage('homePage')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                返回主页
                            </button>
                        </div>
                        
                        <!-- 预算信息 -->
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-blue-800">总预算</div>
                                <div class="text-2xl font-bold text-blue-900">¥${trip.budget?.toLocaleString() || '0'}</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-green-800">目的地</div>
                                <div class="text-2xl font-bold text-green-900">${trip.destination}</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <div class="text-sm font-medium text-purple-800">同行人数</div>
                                <div class="text-2xl font-bold text-purple-900">${trip.travelers}人</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI生成的行程安排 -->
                    ${trip.aiData ? `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">🤖 AI生成的行程安排</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <p class="text-gray-700">${trip.aiData.summary || 'AI为您精心规划的旅行行程'}</p>
                            </div>
                            
                            ${trip.aiData.itinerary && trip.aiData.itinerary.length > 0 ? `
                                <div class="mt-4 space-y-4">
                                    ${trip.aiData.itinerary.map((day, dayIndex) => `
                                        <div class="border-l-4 border-blue-500 pl-4">
                                            <div class="flex justify-between items-center mb-2">
                                                <h4 class="font-semibold text-gray-900">${day.dayTitle || `第${dayIndex + 1}天：${new Date(day.date).toLocaleDateString('zh-CN')}`}</h4>
                                                ${day.dailyBudget ? `<span class="text-sm font-bold text-green-600">每日预算: ¥${day.dailyBudget}</span>` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                ${day.activities ? day.activities.map(activity => `
                                                    <div class="flex items-start space-x-3 bg-white p-3 rounded-lg border">
                                                        <span class="text-gray-400">🕐</span>
                                                        <div class="flex-1">
                                                            <div class="flex justify-between items-start">
                                                                <div>
                                                                    <p class="font-medium text-gray-900">${activity.title}</p>
                                                                    <p class="text-sm text-gray-600">${activity.description}</p>
                                                                    ${activity.location ? `<p class="text-xs text-blue-600">📍 ${activity.location}</p>` : ''}
                                                                </div>
                                                                <div class="text-right">
                                                                    ${activity.cost ? `<p class="text-sm font-bold text-green-600">¥${activity.cost}</p>` : ''}
                                                                    ${activity.category ? `<p class="text-xs text-gray-500">${activity.category}</p>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('') : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            ${trip.aiData.recommendations ? `
                                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${trip.aiData.recommendations.restaurants && trip.aiData.recommendations.restaurants.length > 0 ? `
                                        <div class="bg-yellow-50 p-4 rounded-lg">
                                            <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                                <span class="mr-2">🍽️</span>
                                                餐厅推荐
                                            </h4>
                                            <ul class="text-sm text-yellow-700 space-y-1">
                                                ${trip.aiData.recommendations.restaurants.map(restaurant => `<li>• ${restaurant}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${trip.aiData.recommendations.attractions && trip.aiData.recommendations.attractions.length > 0 ? `
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                                                <span class="mr-2">🏛️</span>
                                                景点推荐
                                            </h4>
                                            <ul class="text-sm text-green-700 space-y-1">
                                                ${trip.aiData.recommendations.attractions.map(attraction => `<li>• ${attraction}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    
                                    ${trip.aiData.recommendations.tips && trip.aiData.recommendations.tips.length > 0 ? `
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                                                <span class="mr-2">💡</span>
                                                实用贴士
                                            </h4>
                                            <ul class="text-sm text-blue-700 space-y-1">
                                                ${trip.aiData.recommendations.tips.map(tip => `<li>• ${tip}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${trip.aiData.budgetSummary ? `
                                <div class="mt-6 bg-white p-6 rounded-lg border">
                                    <h3 class="text-xl font-bold text-gray-900 mb-4">💰 预算分配</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div class="bg-blue-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-blue-800">交通费用</div>
                                            <div class="text-2xl font-bold text-blue-900">¥${trip.aiData.budgetSummary.transportation?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-green-800">住宿费用</div>
                                            <div class="text-2xl font-bold text-green-900">¥${trip.aiData.budgetSummary.accommodation?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="bg-yellow-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-yellow-800">餐饮费用</div>
                                            <div class="text-2xl font-bold text-yellow-900">¥${trip.aiData.budgetSummary.dining?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="bg-purple-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-purple-800">景点门票</div>
                                            <div class="text-2xl font-bold text-purple-900">¥${trip.aiData.budgetSummary.attractions?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="bg-pink-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-pink-800">购物预算</div>
                                            <div class="text-2xl font-bold text-pink-900">¥${trip.aiData.budgetSummary.shopping?.toLocaleString() || '0'}</div>
                                        </div>
                                        <div class="bg-gray-50 p-4 rounded-lg">
                                            <div class="text-sm font-medium text-gray-800">总预算</div>
                                            <div class="text-2xl font-bold text-gray-900">¥${trip.aiData.budgetSummary.total?.toLocaleString() || '0'}</div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="text-center py-8">
                            <p class="text-gray-500">暂无AI生成的行程安排</p>
                        </div>
                    `}
                    
                    <!-- 操作按钮 -->
                    <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                        <div class="flex space-x-4">
                            <button onclick="editTrip('${trip._id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                ✏️ 编辑
                            </button>
                            <button onclick="deleteTrip('${trip._id}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                                🗑️ 删除
                            </button>
                        </div>
                        <div class="text-sm text-gray-500">
                            创建时间: ${new Date(trip.createdAt).toLocaleString('zh-CN')}
                        </div>
                    </div>
                </div>
            `;
            
            showPage('resultPage');
        }

        // 编辑旅行规划
        async function editTrip(tripId) {
            try {
                showNotification('正在加载旅行规划信息...', 'info');
                
                const response = await fetch(`/api/trips/${tripId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const trip = await response.json();
                    // 填充表单数据
                    document.getElementById('destination').value = trip.destination || '';
                    document.getElementById('startDate').value = trip.startDate || '';
                    document.getElementById('endDate').value = trip.endDate || '';
                    document.getElementById('budget').value = trip.budget || '';
                    document.getElementById('travelers').value = trip.travelers || '';
                    document.getElementById('preferences').value = trip.preferences?.interests?.join(', ') || '';
                    document.getElementById('voiceText').textContent = trip.preferences?.specialRequirements || '';
                    
                    // 跳转到规划页面
                    showPage('plannerPage');
                    showNotification('已加载旅行规划信息，您可以修改后重新生成', 'success');
                } else {
                    showNotification('获取旅行规划信息失败', 'error');
                }
            } catch (error) {
                console.error('编辑旅行规划失败:', error);
                showNotification('编辑旅行规划失败，请重试', 'error');
            }
        }

        // 删除旅行规划
        async function deleteTrip(tripId) {
            if (!confirm('确定要删除这个旅行规划吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/trips/${tripId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    showNotification('旅行规划删除成功', 'success');
                    loadUserTrips(); // 重新加载列表
                } else {
                    showNotification('删除失败，请重试', 'error');
                }
            } catch (error) {
                console.error('删除旅行规划失败:', error);
                showNotification('删除失败，请重试', 'error');
            }
        }

        // 搜索和筛选功能
        let allTrips = []; // 存储所有旅行规划数据
        
        function filterTrips() {
            const searchTerm = document.getElementById('searchTrips')?.value.toLowerCase() || '';
            const filterType = document.getElementById('filterType')?.value || '';
            
            let filteredTrips = allTrips.filter(trip => {
                const matchesSearch = !searchTerm || 
                    trip.title.toLowerCase().includes(searchTerm) ||
                    trip.destination.toLowerCase().includes(searchTerm);
                
                const matchesFilter = !filterType || 
                    (filterType === 'ai' && trip.aiGenerated) ||
                    (filterType === 'manual' && !trip.aiGenerated);
                
                return matchesSearch && matchesFilter;
            });
            
            displayUserTrips(filteredTrips);
        }
        
        function sortTrips() {
            const sortBy = document.getElementById('sortTrips')?.value || 'newest';
            
            const sortedTrips = [...allTrips].sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return new Date(b.createdAt) - new Date(a.createdAt);
                    case 'oldest':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'budget-high':
                        return (b.budget || 0) - (a.budget || 0);
                    case 'budget-low':
                        return (a.budget || 0) - (b.budget || 0);
                    case 'destination':
                        return a.destination.localeCompare(b.destination);
                    default:
                        return 0;
                }
            });
            
            displayUserTrips(sortedTrips);
        }
        
        // 修改loadUserTrips函数以保存数据
        async function loadUserTrips() {
            try {
                const response = await fetch('/api/trips', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📋 前端接收到的旅行规划数据:', data);
                    allTrips = data || []; // 保存所有数据
                    displayUserTrips(allTrips);
                } else {
                    console.error('加载旅行规划失败');
                    displayUserTrips([]);
                }
            } catch (error) {
                console.error('加载旅行规划失败:', error);
                displayUserTrips([]);
            }
        }
        
        // 检查是否已登录
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                // 可以在这里验证token并自动登录
                updateNavbarForLoggedInUser();
                loadUserTrips(); // 加载用户的旅行规划
                showPage('homePage');
            } else {
                updateNavbarForGuest();
                showPage('homePage');
            }
        });
    </script>
</body>
</html>
